# Εργασία

## Σκοπός

Στην εργασία σας θ αυλοποιήσετε ένα σύστημα παραγγελιών και διανομής πίτσας με χρήσητου πακέτου νημάτων POSIXthreads(pthreads).

Στο σύστημα αυτό δίνονται παραγγελίες τηλεφωνικά, πληρώνονται με κάρτα, κάθε παραγγελία παρασκευάζεται, πακετάρεταικαι τελικά διανέμεται στον πελάτη.

Στα συστήματα αυτά έχουμε μεγάλο αριθμό παραγγελιώνοι οποίοι εξυπηρετούνται από περιορισμένο αριθμό σημείων εξυπηρέτησης, συνεπώς το πρόγραμμά σας πρέπει να υλοποιεί αμοιβαίο αποκλεισμό (με mutexes) και συγχρονισμό (με μεταβλητές συνθήκης).

Ο κώδικάς σας θα πρέπει να λειτουργεί σωστά στην εικονική μηχανή που διατίθεται στα CSLAB και στο διαδίκτυο βλ. ανακοίνωση στο eclass).

Η εργασία είναι ομαδική και είναι σχεδιασμένη για ομάδες δύο (2) ή τριών (3) ατόμων.Ο βαθμός της εργασίας θα είναι το 30% του τελικού βαθμού (δηλαδή, 3 μονάδες στις 10).

## Αντικείμενο

Η πιτσαρία διαθέτει Ntel τηλεφωνητές, Ncook ψήστες, Νoven φούρνους, έναν υπάλληλο πακεταρίσματος και Ndeliverer διανομείς.

Ο πρώτος πελάτης τηλεφωνεί τη χρονική στιγμή 0,και κάθε επόμενος πελάτης τηλεφωνεί μετά από ένα τυχαίο ακέραιο χρονικό διάστημα στην περιοχή Torderlow,Torderhigh].

Όταν όλοι οι τηλεφωνητές είναι απασχολημένοι, ο πελάτης περιμένει τον επόμενο διαθέσιμο τηλεφωνητή.

Όταν ένας πελάτης συνδεθεί με κάποιον τηλεφωνητή, επιλέγει έναν τυχαίο ακέραιο αριθμό από πίτσες στο διάστημα [`Norderlow`, `Νorderhigh`] και ο τηλεφωνητής χρειάζεται έναν τυχαίο αριθμό λεπτών στο διάστημα [`Tpaymentlow`, `Tpaymenthigh`] για να χρεώσει την πιστωτική κάρτα του πελάτη.

Με πιθανότητα `Pfail` η χρέωση αποτυγχάνει και η παραγγελία ακυρώνεται, αλλιώς η παραγγελία καταχωρείταικαι τα έσοδα αυξάνονται κατά `Cpizza` ευρώ ανά πίτσα.

Η καταχωρημένη παραγγελία αρχικά περιμένει μέχρι ένας ψήστης να γίνει διαθέσιμος.

Όταν συμβεί αυτό, ο ψήστης χρειάζεται `Tprep` χρόνο να ετοιμάσει κάθε πίτσα.

Στη συνέχεια, ο ψήστης περιμένει μέχρι να γίνουν αρκετοί φούρνοι διαθέσιμοι, ώστε όλες οι πίτσες να ψηθούν παράλληλα, γιατί κάθε φούρνος χωράει μία μόνο πίτσα.

Όταν οι κατάλληλοι φούρνοι είναι διαθέσιμοι, κάθε πίτσα μπαίνει σε έναν φούρνο και ο ψήστης αναλαμβάνει την επόμενη παραγγελία.

Οι πίτσες ψήνονται για χρόνο `Tbake`.

Όταν ολοκληρωθεί το ψήσιμο, οι φούρνοι κλείνουν αυτόματα και περιμένουν τον (μοναδικό) υπάλληλο πακεταρίσματος να βγάλει τις πίτσες από τους φούρνους και να τις πακετάρει, πράγμα που παίρνει χρόνο `Tpack`.

Σε αυτή τη στιγμή και οι φούρνοι απελευθερώνονται.

Όταν ένας διανομέας γίνει διαθέσιμος, παραλαμβάνει μία πακεταρισμένη παραγγελία και την παραδίδει στον πελάτη, με την παράδοση να διαρκεί ένα τυχαίο ακέραιο χρονικό διάστημα στην περιοχή [`Tdellow`,`Tdelhigh`].

Μετά την παράδοση, ο διανομέας χρειάζεται το ίδιο ακριβώς διάστημα ώστε να επιστρέψει στο κατάστημα και να αναλάβει την επόμενη παραγγελία.

Κάθε ψήστης ασχολείται με μία μόνο παραγγελία μέχρι να την βάλει στο φούρνο και κάθε διανομέας μεταφέρει μία μόνο παραγγελία σε κάθε διαδρομή.

## Είσοδος και δεδομένα

Οι ακόλουθες σταθερές θα ορίζονται σε ένα αρχείο δηλώσεων:

- `Ntel` = 3 τηλεφωνητές
- `Ncook` = 2 ψήστες
- `Noven` = 10 φούρνοι
- `Ndeliverer` = 7 διανομείς
- `Torderlow` = 1 λεπτό
- `Torderhigh` = 5 λεπτά
- `Norderlow` = 1 πίτσες
- `Norderhigh` = 5 πίτσες
- `Tpaymentlow` = 1λεπτό
- `Tpaymenthigh` = 2 λεπτά
- `Cpizza` = 10 ευρώ
- `Pfail` = 5%
- `Tprep` = 1λεπτό
- `Tbake` = 10 λεπτά
- `Tpack` = 2λεπτά
- `Tdellow` = 5 λεπτά
- `Tdelhigh` = 15 λεπτά

Το πρόγραμμά σας θα δέχεται δύο (ακριβώς) παραμέτρους με το πλήθος των πελατών προς εξυπηρέτηση, Ncust, και τον τυχαίο σπόρο για τη γεννήτρια των τυχαίων αριθμών.

## Έξοδος εργασίας

Για κάθε παραγγελία, θα τυπώνονται τα παρακάτω μηνύματα στην οθόνη στις κατάλληλες χρονικές στιγμές:

- Η παραγγελία με αριθμό `<oid>` απέτυχε / καταχωρήθηκε. [Τη στιγμή αποτυχίας ή καταχώρησης της παραγγελίας.]

- Η παραγγελία με αριθμό `<oid>` ετοιμάστηκε σε `<X>` λεπτά. [Τη στιγμή που ολοκληρώνεται το πακετάρισμα μιας επιτυχημένης παραγγελίας.]

- Η παραγγελία με αριθμό `<oid>` παραδόθηκε σε `<Y>` λεπτά. [Τη στιγμή που ολοκληρώνεται η παράδοση μιας επιτυχημένης παραγγελίας.]

Η σειρά των γραμμών θα είναι τυχαία, αλλά οι γραμμές δεν πρέπει να μπλέκονται μεταξύ τους.

To `<Χ>` συμβολίζει το διάστημα από την εμφάνιση του πελάτη μέχρι το πακετάρισμα της παραγγελίας, ενώ το `<Y>` το διάστημα από την εμφάνιση του πελάτη μέχρι την παράδοση της παραγγελίας.

Στο τέλος της εκτέλεσης, το σύστημα θα τυπώνει τα ακόλουθα:

- Τα συνολικά έσοδα από τις πωλήσεις και το πλήθος επιτυχημένων και αποτυχημένων παραγγελιών.
- Το μέσο και μέγιστο χρόνο αναμονής των πελατών (από τη στιγμή που εμφανίζεται ο πελάτης, μέχρι να μιλήσει με τον τηλεφωνητή) – περιλαμβάνονται και οι αποτυχημένες παραγγελίες.
- Το μέσο και μέγιστο χρόνο εξυπηρέτησης των πελατών (από τη στιγμή που εμφανίζεται ο πελάτης, μέχρι να παραδοθεί η παραγγελία) – μόνο για τις επιτυχημένες παραγγελίες.
- Το μέσο και μέγιστο χρόνο κρυώματος των παραγγελιών (από τη στιγμή που ολοκληρώνεται το ψήσιμο μέχρι τη στιγμή που παραδίδεται η παραγγελία) – μόνο για τις επιτυχημένες παραγγελίες.

## Δομή κώδικα

Το αρχικό νήμα του προγράμματός σας θα δημιουργεί ένα νήμα ανά πελάτη/παραγγελία (συνολικά `Ncust` νήματα) στο οποίο θα μεταβιβάζετε έναν αριθμό νήματος (από 1 έως `Ncust`) ώστε να τον χρησιμοποιείτε ως αριθμό παραγγελίας. Κάθε νήμα στη συνέχεια θα εκτελεί τα παραπάνω βήματα μέχρι να ολοκληρωθεί η παραγγελία και θα τυπώνει την κατάλληλη έξοδο. Τέλος, το αρχικό νήμα θα τυπώνει την τελική έξοδο. Θα χρειαστείτε τουλάχιστον τα ακόλουθα:

- Μία ακέραιη μεταβλητή και ένα mutexγια να μετράτε το πλήθος των διαθέσιμων τηλεφωνητώνκαι μία μεταβλητή συνθήκης για να συγχρονίσετε τους πελάτες με τους τηλεφωνητές, έτσι ώστε όταν δεν υπάρχουν διαθέσιμοι τηλεφωνητές να μπλοκάρονται οι πελάτες. Με ανάλογο τρόπο θα πρέπει να χειριστείτε τους ψήστες, τους φούρνους, τον υπάλληλο πακεταρίσματοςκαι τους διανομείς.
- Μεταβλητές και τα σχετικά mutexγια τα έσοδα και τα στατιστικά.
- Ένα mutexγια κλείδωμα της οθόνης όταν τυπώνετε την έξοδο

Προσοχή στο να τερματίζετε σωστά τα νήματα, να τα περιμένετε όπου χρειάζεταικαι (κυρίως!) να απελευθερώνετε σωστά όση μνήμη δεσμεύετε.

## Υποδείξεις

- Για να ολοκληρώνεται σε λογικό χρονικό διάστημα το πρόγραμμά σας, αντιμετωπίστε όλους τους χρόνους που δίνονται σαν δευτερόλεπτα αντί για λεπτά.
- Κατά τη μεταγλώττιση πρέπει να δίνετε την επιλογή `–pthread` για να χρησιμοποιηθεί η βιβλιοθήκη POSIXthreads.
- Για να προσομοιώσετε το χρόνο που διαρκεί κάποιο διάστημα (π.χ. ψησίματος) θα χρησιμοποιήσετε την` `unsignedintsleep(unsignedintseconds)`.
- Για να παράγετε μία σειρά ψευδοτυχαίων αριθμών, θα χρησιμοποιήσετε την int `rand_r(unsignedint*seedp)`. Χρησιμοποιήστε τον τελεστή % για να περιορίσετε το εύρος τιμών των τυχαίων αριθμών.
- Για  τον  υπολογισμό  τωνχρόνων  αναμονής, χρησιμοποιείστε την `intclock_gettime(clockid_tclk_id, conststructtimespec*tp)` στην αρχή και τέλος κάθε πράξης, με πρώτη παράμετρο τη σταθερά `CLOCK_REALTIME`. Στην έξοδο, μετατρέψτε τους χρόνους που προκύπτουν από δευτερόλεπτα σε λεπτά.
- Χρησιμοποιήστε έναν βρόχο με `while` για να ελέγχετε τη συνθήκη αναμονήςκαι να κάνετε `pthread_cond_wait` για όσες φορές χρειάζεται.
- Προσοχή στο ότι μπορεί να χρειαστεί να δεσμεύσουμε πολλούς φούρνους για μία παραγγελία.
- Προσοχή στο πότε δεσμεύεται και αποδεσμεύεται κάθε πόρος (τηλεφωνητής, ψήστης, φούρνος, υπάλληλος πακεταρίσματος και διανομέας).

## Παραδοτέα

Ο κώδικάς σας πρέπει να αποτελείται από ένα αρχείο με δηλώσεις (συμπεριλαμβανομένων των σταθερών) και ένα αρχείο κώδικα Cγια τοπρόγραμμα. 

Τα αρχεία αυτά πρέπει να έχουν ονόματα της μορφής `p3x-p3y-p3z-pizza.h` για τις δηλώσεις, `p3x-p3y-p3z-pizza.c` για τον κώδικα C , όπου και `p3x-p3y-p3z` είναι οι αριθμοί μητρώου σας.

Εκτός από τον κώδικα, θα πρέπει να γράψετε μία αναφορά η οποία να περιγράφει τη δομή του κώδικά σας και να αναφέρει τυχόν περιορισμούς ή πρόσθετα χαρακτηριστικά που έχετε υλοποιήσει.

Η αναφορά πρέπει να είναι ένα αρχείο σε μορφή PDF με όνομα της μορφής `p3x-p3y-p3z-pizza.pdf`.

Τέλος, θα πρέπει να συμπεριλάβετε ένα αρχείο με όνομα test-res.shτο οποίο θα μεταγλωττίζει και θα εκτελεί το πρόγραμμά σας με παραμέτρους 100 πελάτες και αρχικό σπόρο 1000.

Αυτά τα τέσσερααρχεία (και τίποτα άλλο) θα πρέπει να συμπιεστούν σε ένα αρχείο σε μορφή zipμε όνομα της μορφής `p3x-p3y-p3z-pizza.zip` και να υποβληθούν από ένα μόνο μέλος της ομάδας μέσω της υποβολής εργασιών του eclass.

## Προθεσμία υποβολής

Τα συμπιεσμένα αρχεία με τις εργασίες σας θα πρέπει να παραδοθούν μέσω του eclass μέχρι την Παρασκευή 31/5/2021 και ώρα 23:59.

## Βαθμολόγηση και εξέταση

Εργασίες με ομοιότητες που υποδεικνύουν αντιγραφή θα μηδενιστούν όλες(θα γίνει έλεγχος με ειδικό πρόγραμμα).

Δειγματοληπτικά, θα κληθούν ορισμένες ομάδες για προφορική εξέταση στα CSLAB. Μέλη ομάδων, ή και ολόκληρες ομάδες, που δεν θα προσέλθουν στην προφορική εξέταση, θα μηδενιστούν.

Η βαθμολόγηση εξετάζει ταεξωτερικά χαρακτηριστικά της εργασίας (ονοματολογία αρχείων, αναφορά, μεταγλώττιση χωρίς σφάλματα, κανονική ολοκλήρωση), την ποιότητα του κώδικα (σωστή δόμηση, σχολιασμός, έλεγχος για σφάλματα)και την υλοποίηση των απαιτήσεων (κλειδώματα και συνθήκες ανά φάσητης παραγγελίας, υπολογισμός στατιστικών, έξοδος).
